# HDMI PROCESSING AND OVERLAY (ON-SCREEN DISPLAY) USING THE CYCLONE V

Duration: May - June 2019

Author: Li Ding

Collaborator: Zhe Bai

## Introduction

In this lab session, we created a program to display a re-configurable picture via HDMI by using FPGA and Analog Devices ADV7513 HDMI Transmitter. Two IP blocks were used, PLL block for generating different frequency clock and ROM block for creating lookup table.

A functional block diagram showed below is a diagram illustrates the system’s overall inputs and outputs.

<img width="343" alt="functional_block_diagram" src="https://user-images.githubusercontent.com/15827364/79717957-4e0db480-831e-11ea-9071-a0f1fa1f5b72.PNG">

## Module Design

In this design, we used a PLL to generate 25.175MHz clock to drive Rom block and HDMI module. A ROM was used to store the target image that would be transmit to the monitor. This two functional blocks were generated in the Quartus platform. 

<img width="638" alt="i2c bus communication" src="https://user-images.githubusercontent.com/15827364/81383619-a254c900-9153-11ea-8533-1875ffc0b5c8.PNG">

Mostly, the focus of this design is the I2C bus design. As the image showed above, two signal lines are used for I2C transaction which are SDA and SCL. To initialise a communication between master device and slave device, a start signal needs to be generated by pulling SDA down while SCL stays high. Then each byte of data would be sent followed by a acknowledge signal from slave device. After the complete transmission of three-byte data, the stop signal is sent from the master device to end the transmission by pulling SDA from low to high while keeping SCL high.

<img width="251" alt="i2ccontroller_rtl" src="https://user-images.githubusercontent.com/15827364/81383730-ddef9300-9153-11ea-9fc7-b93e0aa46dd5.PNG">

So, the main inputs of the I2C controller contain reference clock, reset, 24 bits configuration data (include device address, register address and data), start signal and stop signal respectively. On the other hand, the outputs include SCL, ready signal, end signal and a bidirectional SDA. Through I2C controller, the ADV7513 chip can be configured by sending each valid configuration data, start signal and stop signal.

Lastly, to design a HDMI module, the general idea is setting two ‘counters’, counting horizontal pixels (640+48+96+16=800 in total) and vertical pixels (480+11+2+31=524 in total), the counters will reset to 0 if they reach to the limits (800 on row and 524 on the column). Picture below illustrates the active pixels and V/H sync area.

After each module is built up and simulated, the top-level entity would composite them together as the functional block diagram shows. And the final implementation can be test on board. 

## Results and Discussions

Due to the limited time for the project, we could only test the functionality of our I2C bus, HDMI module and PLL block, which means the ROM was not applied in the testing stage. Alternatively, we simply used pure colour picture to test our design and it seemed work on particular monitor.

<img width="864" alt="toplevel_rtl" src="https://user-images.githubusercontent.com/15827364/81383796-011a4280-9154-11ea-80cf-6c81ac0c131b.PNG">

As the top-level entity structure showed above, the main design contains PLL module, I2C module and HDMI module. As for the image data input port, we gave it a 24 bits data representing a pure colour image for testing purpose. And we did have some expected outcomes, as we changed the image data input, different colours can be displayed on the screen (see picture below).

<img width="718" alt="Screen Shot 2020-05-08 at 5 57 47 pm" src="https://user-images.githubusercontent.com/15827364/81384761-789ca180-9155-11ea-8a80-b53e933c6129.png">

## Problems that we haven't solved

In the I2C implementation part, the function of I2C module would be verified by using WaveForms through Analog Discovery 2. Some of the registers can be successfully configured. 

<img width="883" alt="all good ACK" src="https://user-images.githubusercontent.com/15827364/81385445-b221dc80-9156-11ea-995d-94dcbf6a5af5.PNG">

However, NAK situation appeared while the master device was sending register addresses or data value as shown in images below. This might cause errors when displaying a normal image instead of pure colour image. Further study for I2C bus protocol and solutions to address this problem are needed. 

<img width="895" alt="register write NAK" src="https://user-images.githubusercontent.com/15827364/81385237-59eada80-9156-11ea-93ef-e568a2c4fbd0.PNG">
<img width="887" alt="data write NAK" src="https://user-images.githubusercontent.com/15827364/81385309-79820300-9156-11ea-842b-4379a6e9fe80.PNG">
